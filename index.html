<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNTN KINH DOANH VÀNG BẠC - NHƠN</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Oswald:wght@200..700&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <style>
        /* --- Cài đặt chung & Reset --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000000;
            color: white;
            font-family: 'Open Sans', sans-serif; /* Font mặc định */
            height: 100vh;
            overflow: hidden;
            padding: 5px;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            gap: 15px;
        }

        /* --- Header: Banner ở giữa --- */
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .banner {
            height: auto;
            width: 100%;
            object-fit: contain;
        }

        /* --- Tiêu đề và đồng hồ số cùng hàng --- */
        .title-section {
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            margin: -10px 20px 20px 20px; /* Di chuyển lên trên */
        }

        .gold-title {
            color: #ff0000;
            font-size: 2.0rem;
            font-weight: bold;
            margin: 0;
            white-space: pre; /* Để nhận dấu cách */
        }

        /* --- Đồng hồ số 24h với ngày tháng --- */
        .digital-clock-container {
            background: linear-gradient(135deg, #003cff, #0056ff);
            border: 2px solid #f4dc60;
            border-radius: 15px;
            padding: 20px 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 400px;
        }

        .time-display {
            font-size: 3.0rem;
            font-weight: bold;
            color: #f4dc60;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            line-height: 1.2;
        }

        .date-display {
            font-size: 1.2rem;
            color: #ffffff;
            margin-top: 10px;
            text-align: center;
            line-height: 1.4;
        }

        /* --- Nội dung chính --- */
        .main-content {
            flex: 1;
            display: flex;
            gap: 20px;
            overflow: hidden;
            margin-top: -15px; /* Đưa main-content lên trên */
        }

        /* --- Bảng giá vàng --- */
        .gold-section {
            flex: 1; /* Chiếm toàn bộ không gian */
            display: flex;
            flex-direction: column;
        }

        .gold-table-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            flex: 1;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(244, 220, 96, 0.3);
            position: relative;
        }

        .gold-table {
            width: 100%;
            height: 100%;
            border-collapse: separate;
            border-spacing: 0;
            display: table;
            table-layout: fixed;
        }

        .gold-table thead {
            display: table-header-group;
        }

        .gold-table tbody {
            display: table-row-group;
            height: calc(100% - 80px); /* Trừ đi chiều cao của header */
            overflow-y: auto;
        }

        .gold-table th {
            background: linear-gradient(135deg, #003cff, #0056ff);
            color: #ffffff;
            font-family: 'Open Sans', sans-serif; /* Font mặc định */
            font-size: 1.8rem;
            font-weight: bold;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            position: sticky;
            top: 0;
            z-index: 5;
            height: 50px;
            box-sizing: border-box;
        }

        .gold-table td {
            background: rgba(200, 0, 0, 0.9); /* Nền đỏ đậm hơn, ít trong suốt */
            color: #f4dc60;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); /* Thêm bóng đổ chữ */
            font-family: 'Open Sans', sans-serif; /* Font mặc định */
            font-size: 1.2rem;
            font-weight: bold;
            padding: 5px 5px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
            box-sizing: border-box;
            height: 44px;
        }

        .gold-table tbody tr:nth-child(even) td {
            background: rgba(255, 0, 0, 0.7);
        }

        .gold-table tbody tr:hover td {
            background: rgba(255, 100, 100, 0.8);
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        .last-updated {
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: normal;
            opacity: 0.8;
            text-align: center;
            margin-top: 15px;
        }

        /* --- Trạng thái --- */
        .loading, .error {
            text-align: center;
            font-size: 1.5rem;
            padding: 20px;
            color: #f4dc60;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
        }

        .error {
            color: #ff6b6b;
        }

        /* --- Media Queries cho TV 32 inch (1366x768) --- */
        @media (max-width: 1366px) {
            .header {
                min-height: 120px; /* Giảm chiều cao header */
            }

            .banner {
                height: 80px; /* Giảm kích thước banner */
                width: 800px;
            }

            .gold-title {
                font-size: 1.8rem; /* Giảm font-size */
            }

            .digital-clock-container {
                padding: 12px 20px; /* Giảm padding */
                min-width: 350px;
            }

            .time-display {
                font-size: 2.5rem; /* Giảm font-size */
            }

            .date-display {
                font-size: 1.0rem;
            }

            .gold-table th {
                font-size: 2.0rem; /* Giảm font-size */
                padding: 12px;
                height: 30px;
            }

            .gold-table td {
                font-size: 2.4rem; /* Giảm font-size */
                padding: 5px 5px;
                height: 44px;
            }

            .gold-table tbody {
                height: calc(100% - 40px);
            }

            .last-updated {
                font-size: 0.9rem; /* Giảm font-size */
            }
        }

        /* --- Media Queries cho TV lớn hơn --- */
        @media (min-width: 1920px) {
            .header {
                min-height: 350px;
            }

            .banner {
                height: 280px;
                width: 1500px;
            }

            .gold-title {
                font-size: 4rem;
            }

            .digital-clock-container {
                padding: 25px 40px;
                min-width: 500px;
            }

            .time-display {
                font-size: 4.5rem;
            }

            .date-display {
                font-size: 1.5rem;
            }

            .gold-table th {
                font-size: 1.8rem;
                padding: 20px;
                height: 70px;
            }

            .gold-table td {
                font-size: 1.5rem;
                padding: 15px 20px;
                height: 60px;
            }

            .gold-table tbody {
                height: calc(100% - 50px);
            }

            .last-updated {
                font-size: 1.3rem;
            }
        }
        
        .gold-table th {
            font-size: 2.0rem !important;
        }

        .gold-table td {
            font-size: 2.6rem !important;
        }
        
        .gold-title {
            font-size: 2.6rem !important;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header với banner ở giữa -->
    <div class="header">
         <img class="banner" src="https://raw.githubusercontent.com/s2voks2-wq/tiemvangnhon/main/banner.png" alt="Banner cửa hàng">
    </div>

    <!-- Tiêu đề và đồng hồ số cùng hàng -->
    <div class="title-section">
      
        <h1 class="gold-title">           </h1>
        <h1 class="gold-title">         </h1>
        <h1 class="gold-title">GIÁ VÀNG HÔM NAY</h1>
        <h1 class="gold-title">                     </h1>
<div class="time-display" id="digitalTime">00:00:00</div>
       
        <div class="date-display" id="dateInfo"></div>
    </div>

    <!-- Nội dung chính -->
    <div class="main-content">
        <!-- Bảng giá vàng (toàn bộ không gian) -->
        <div class="gold-section">
            <div class="gold-table-container">
                <div id="tableContainer">
                    <div class="loading">Đang tải dữ liệu...</div>
                </div>
            </div>
            <h1class="last-updated" CHẤT LƯỢNG VÀNG - NIỀM TIN VÀNG</h1>
        </div>
    </div>
</div>

<script>
    const SHEET_ID = '1v4s-tgmpa9OXsbl12aHt_2sl2n16zA0vRR4FkCkSJz8';
    const API_KEY = 'AIzaSyCKFIJmJftdBoC95PKz5Q3ZqgK3GJPrd0g';
    const SHEET_NAME = 'Sheet1';

    // Biến lưu trữ dữ liệu
    let goldDataCache = null;
    let lastFetchTime = 0;

    // Biến quản lý thời gian
    let timeOffset = 0; // Độ lệch thời gian với server (ms)
    let isOnline = false;
    let lastSyncTime = 0;
    const SYNC_INTERVAL = 5 * 60 * 1000; // Đồng bộ mỗi 5 phút

    function formatNumber(num) {
        if (!num || num === '') return '';
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    /* HÀM ĐỒNG BỘ THỜI GIAN VỚI SERVER */
    async function syncTimeWithServer() {
        try {
            const startTime = Date.now();

            // Sử dụng World Time API cho múi giờ Việt Nam
            const response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Ho_Chi_Minh', {
                method: 'GET',
                cache: 'no-cache'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            const endTime = Date.now();
            const networkDelay = (endTime - startTime) / 2;

            // Thời gian server (đã điều chỉnh theo network delay)
            const serverTime = new Date(data.datetime).getTime() + networkDelay;
            const localTime = Date.now();

            // Tính độ lệch
            timeOffset = serverTime - localTime;
            isOnline = true;
            lastSyncTime = Date.now();

            updateSyncStatus(true);
            console.log(`Đồng bộ thời gian thành công. Độ lệch: ${timeOffset}ms`);

            return true;
        } catch (error) {
            console.error('Lỗi đồng bộ thời gian:', error);
            isOnline = false;
            updateSyncStatus(false);
            return false;
        }
    }

    /* CẬP NHẬT TRẠNG THÁI ĐỒNG BỘ */
    function updateSyncStatus(online) {
        const syncText = document.getElementById('syncText');
        const syncIndicator = document.getElementById('syncIndicator');

        if (online) {
            if (syncText) syncText.textContent = 'Online';
            if (syncIndicator) {
                syncIndicator.className = 'sync-indicator online';
            }
        } else {
            if (syncText) syncText.textContent = 'Offline';
            if (syncIndicator) {
                syncIndicator.className = 'sync-indicator offline';
            }
        }
    }

    /* LẤY THỜI GIAN HIỆN TẠI (ĐÃ ĐIỀU CHỈNH) */
    function getCurrentTime() {
        const now = new Date(Date.now() + timeOffset);
        return now;
    }

    /* HÀM TÍNH NGÀY ÂM LỊCH */
    function getLunarDate(solarDate) {
        const jd = getJulianDay(solarDate);
        const lunarMonth = Math.floor((jd - 2415021) / 29.53) % 12 + 1;
        const lunarDay = Math.floor((jd - 2415021) % 29.53) + 1;
        const lunarYear = solarDate.getFullYear();
        return {
            day: Math.max(1, Math.min(30, lunarDay)),
            month: lunarMonth,
            year: lunarYear
        };
    }

    /* HÀM TÍNH JULIAN DAY */
    function getJulianDay(date) {
        const a = Math.floor((14 - (date.getMonth() + 1)) / 12);
        const y = date.getFullYear() + 4800 - a;
        const m = (date.getMonth() + 1) + 12 * a - 3;
        return date.getDate() + Math.floor((153 * m + 2) / 5) + 365 * y +
               Math.floor(y / 4) - Math.floor(y / 100) + Math.floor(y / 400) - 32045;
    }

    /* HÀM CẬP NHẬT ĐỒNG HỒ SỐ VÀ NGÀY THÁNG */
    function updateDigitalClock() {
        const now = getCurrentTime();

        // Định dạng thời gian 24h
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}:${seconds}`;

        // Định dạng ngày dương lịch
        const day = now.getDate().toString().padStart(2, '0');
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const year = now.getFullYear();
        const solarDateString = ` ${day}/${month}/${year}`;

        // Tính ngày âm lịch
        const lunar = getLunarDate(now);
        const lunarDateString = ` ${lunar.day}/${lunar.month}/${lunar.year} (Âm lịch)`;

        // Cập nhật DOM
        const timeElement = document.getElementById('digitalTime');
        if (timeElement) timeElement.textContent = timeString;
        
        const dateElement = document.getElementById('dateInfo');
        if (dateElement) {
            dateElement.innerHTML = `${solarDateString}<br>${lunarDateString}`;
        }
    }

    /* KIỂM TRA VÀ ĐỒNG BỘ THỜI GIAN ĐỊNH KỲ */
    function checkAndSyncTime() {
        const now = Date.now();
        if (now - lastSyncTime > SYNC_INTERVAL) {
            syncTimeWithServer();
        }
    }

    /* LƯU VÀ TẢI DỮ LIỆU LOCAL */
    function saveToLocal(data) {
        try {
            const dataToSave = {
                time: Date.now(),
                values: data
            };
            goldDataCache = data;
            lastFetchTime = Date.now();
        } catch (error) {
            console.error('Lỗi lưu dữ liệu:', error);
        }
    }

    function loadFromLocal() {
        return goldDataCache;
    }

    /* TẢI DỮ LIỆU TỪ GOOGLE SHEETS */
    async function fetchGoldData() {
        const tableContainer = document.getElementById('tableContainer');

        try {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.values && data.values.length > 0) {
                saveToLocal(data.values);
                renderTable(data.values);
                updateLastUpdatedTime();
                console.log('Dữ liệu đã được cập nhật từ Google Sheets');
            } else {
                throw new Error('Không có dữ liệu trong bảng');
            }
        } catch (error) {
            console.error("Lỗi tải dữ liệu:", error);

            // Thử tải từ cache
            const localData = loadFromLocal();
            if (localData && localData.length > 0) {
                renderTable(localData);
                if (tableContainer) {
                    const errorNote = document.createElement('div');
                    errorNote.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: rgba(255, 0, 0, 0.8);
                        color: white;
                        padding: 5px 10px;
                        border-radius: 5px;
                        font-size: 0.8rem;
                        z-index: 10;
                    `;
                    errorNote.textContent = 'Offline - Dữ liệu cache';
                    tableContainer.style.position = 'relative';
                    tableContainer.appendChild(errorNote);
                }
                console.log('Hiển thị dữ liệu từ cache do mất kết nối');
            } else {
                if (tableContainer) {
                    tableContainer.innerHTML = '<div class="error">Không thể tải dữ liệu. Vui lòng kiểm tra kết nối mạng.</div>';
                }
            }
            updateLastUpdatedTime();
        }
    }

    /* HIỂN THỊ BẢNG DỮ LIỆU */
    function renderTable(data) {
        const tableContainer = document.getElementById('tableContainer');
        if (!tableContainer || !data || data.length === 0) return;

        let html = '<table class="gold-table">';

        // Header
        if (data[0]) {
            html += '<thead><tr>';
            data[0].forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead>';
        }

        // Body
        html += '<tbody>';
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            html += '<tr>';
            row.forEach((cell, index) => {
                // Định dạng số cho các cột sau cột đầu tiên
                const formattedCell = (index > 0 && cell) ? formatNumber(cell) : cell;
                html += `<td>${formattedCell || ''}</td>`;
            });
            html += '</tr>';
        }
        html += '</tbody>';
        html += '</table>';

        tableContainer.innerHTML = html;
    }

    /* CẬP NHẬT THỜI GIAN */
    function updateLastUpdatedTime() {
        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (lastUpdatedElement) {
            const now = new Date();
            const timeString = now.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            lastUpdatedElement.textContent = `Cập nhật lần cuối: ${timeString}`;
        }
    }

    /* KHỞI TẠO ỨNG DỤNG */
    function init() {
        console.log('Khởi tạo ứng dụng...');

        // Tải dữ liệu ban đầu
        fetchGoldData();

        // Khởi tạo đồng hồ và ngày tháng
        updateDigitalClock();

        // Thiết lập intervals
        setInterval(updateDigitalClock, 1000); // Cập nhật đồng hồ mỗi giây
        setInterval(fetchGoldData, 30000); // Tải dữ liệu mỗi 30 giây
        setInterval(checkAndSyncTime, 60000); // Kiểm tra đồng bộ thời gian mỗi phút

        console.log('Ứng dụng đã khởi tạo thành công');
    }

    // Khởi động khi trang được tải
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Thêm event listener cho việc tải lại trang
    window.addEventListener('beforeunload', function() {
        console.log('Trang đang được tải lại...');
    });
</script>
</body>
</html>

